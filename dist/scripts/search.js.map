{"version":3,"sources":["../../scripts/search.js"],"names":["Search","el","$el","$input","querySelector","$songs","$singer","addEventListener","onKeyUp","bind","keyword","page","nomore","songs","perpage","fetching","window","onScroll","removeEventListener","document","documentElement","clientHeight","pageYOffset","body","scrollHeight","search","event","target","value","trim","console","log","reset","key","searchSinger","innerHTML","fetch","then","res","json","data","song","curpage","message","list","append","zhida","appendSinger","singerHtml","singermid","singername","songnum","albumnum","html","map","songname","singer","name","join"],"mappings":"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","file":"search.js","sourcesContent":["class Search{\r\n    constructor(el) {\r\n        this.$el = el\r\n        this.$input = this.$el.querySelector(\".search\")\r\n        this.$songs = this.$el.querySelector(\".search-content ul\")\r\n        this.$singer = this.$el.querySelector(\".search-content .singer\")\r\n        this.$input.addEventListener(\"keyup\",this.onKeyUp.bind(this))\r\n        this.keyword = ''\r\n        this.page = 1\r\n        this.nomore = false\r\n        this.songs = []\r\n        this.perpage = 20\r\n        this.fetching = false\r\n        window.addEventListener(\"scroll\",this.onScroll.bind(this))\r\n    }\r\n\r\n    onScroll(){\r\n        if(!this.keyword) return\r\n        if(this.nomore) return window.removeEventListener(\"scroll\", this.onScroll.bind(this))\r\n        if(document.documentElement.clientHeight + pageYOffset > document.body.scrollHeight - 50) {\r\n            this.search(this.keyword, this.page + 1)\r\n        }\r\n    }\r\n\r\n    onKeyUp(event){\r\n        let keyword = event.target.value.trim()\r\n        console.log(keyword)\r\n        if(keyword == '') this.reset()\r\n        if(event.key !== \"Enter\") return\r\n        this.searchSinger(keyword)\r\n        this.search(keyword)\r\n    }\r\n\r\n    reset(){\r\n        this.page = 1\r\n        this.songs = []\r\n        this.keyword = ''\r\n        this.nomore = false\r\n        this.$songs.innerHTML = \"\"\r\n        this.$singer.innerHTML = ''\r\n    }\r\n\r\n    search(keyword, page){\r\n        this.keyword = keyword\r\n        if(this.fetching) return\r\n        this.fetching = true\r\n        fetch(`http://localhost:4000/search?keyword=${this.keyword}&page=${page || this.page}`)\r\n            .then(res => res.json())\r\n            .then(json => {\r\n                this.page = json.data.song.curpage\r\n                this.nomore = (json.message == \"no results\")\r\n                return json.data.song.list\r\n            })\r\n            .then(songs => this.append(songs))\r\n            .then(() => this.fetching = false)\r\n    }\r\n\r\n    searchSinger(keyword){\r\n        fetch(`http://localhost:4000/search?keyword=${keyword}&page=${this.page}`)\r\n            .then(res => res.json())\r\n            .then(json => json.data.zhida)\r\n            .then(zhida => this.appendSinger(zhida))\r\n    }\r\n\r\n    appendSinger(zhida){\r\n        let singerHtml = `\r\n        <div class=\"img\">\r\n                        <img src=\"https://y.gtimg.cn/music/photo_new/T001R68x68M000${zhida.singermid}.jpg?max_age=2592000\" />\r\n                    </div>\r\n                    <div class=\"text\">\r\n                        <h4>${zhida.singername}</h4>\r\n                        <p>单曲: <span>${zhida.songnum}</span> 专辑: <i>${zhida.albumnum}</i></p>\r\n                    </div>`\r\n\r\n        this.$singer.innerHTML = singerHtml\r\n    }\r\n\r\n    append(songs){\r\n        let html = songs.map(song =>`<li>\r\n                <div class=\"img\">\r\n                    <i class=\"icon\"></i>\r\n                </div>\r\n                <div class=\"text\">\r\n                    <h4>${song.songname}</h4>\r\n                    <p>${song.singer.map(singer => singer.name).join(\"/\")}</p>\r\n                </div>\r\n            </li>`\r\n        ).join(\"\")\r\n        this.$songs.innerHTML += html\r\n    }\r\n}"]}